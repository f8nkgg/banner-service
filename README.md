# Banner Service Avito [Backend Application] 

## Содержание 
- [Запуск](#запуск)
- [Примеры запросов и ответов](#примеры-запросов-и-ответов)
- [Реализация](#реализация)
- [ТЗ](#тз)
## Запуск
Запуск с помощью docker compose
```sh
$ make compose-up
```
Интеграционные тесты
```sh
$ make test
```
Обычный запуск сервера
```sh
$ make run
```
Запуск линтера
```sh
$ make lint
```
### Зависимости
- go 1.22.1
- docker & docker-compose
- [golangci-lint](https://github.com/golangci/golangci-lint) (для проверки кода)

Конфигурационный файл лежит по адресу config/config.yml

## Примеры запросов и ответов

### POST  http://localhost:8080/banner

Создание нового баннера

##### Запрос:
```
Content-Type: application/json
Token: admin_token

{
  "tag_ids": [4, 5, 6],
  "feature_id": 123,
  "content": {
    "title": "some_title",
    "text": "some_text",
    "url": "some_url"
  },
  "is_active": true
}

```
##### Ответ:
```
{
  "banner_id": 1
}
```

### GET http://localhost:8080/user_banner?tag_id=4&feature_id=123&use_last_revision=true

Получение баннера для пользователя

##### Запрос:
```
Content-Type: application/json
Token: user_token
```

##### Ответ:
```
{
  "text": "some_text",
  "title": "some_title",
  "url": "some_url"
}
```

### GET http://localhost:8080/banner?feature_id=123&offset=0

Получение всех баннеров c фильтрацией по фиче и/или тегу

##### Запрос:
```
Content-Type: application/json
Token: admin_token
```

##### Ответ:
```
[
  {
    "id": 1,
    "tag_ids": [
      4,
      5,
      6
    ],
    "feature_id": 123,
    "content": {
      "text": "some_text",
      "title": "some_title",
      "url": "some_url"
    },
    "is_active": true,
    "created_at": "2024-04-14T03:44:58.059736+04:00",
    "updated_at": "2024-04-14T03:44:58.059736+04:00"
  }
]
```
### PATCH http://localhost:8080/banner/1

Обновление содержимого баннера

##### Запрос:
```
Content-Type: application/json
Token: admin_token
```

### DELETE http://localhost:8080/banner/1

Удаление баннера по идентификатору

##### Запрос:
```
Content-Type: application/json
Token: admin_token
```

### GET http://localhost:8080/banner/history/1

Получение истории изменений баннера по идентификатору

##### Запрос:
```
Content-Type: application/json
Token: admin_token
```

##### Ответ:
```
[
  {
    "Index": 1,
    "Banner": {
      "id": 1,
      "tag_ids": [
        4,
        5,
        6
      ],
      "feature_id": 123,
      "content": {
        "text": "some_text",
        "title": "some_title",
        "url": "some_url"
      },
      "is_active": true,
      "created_at": "2024-04-14T04:56:16.643184+04:00",
      "updated_at": "2024-04-14T04:56:18.809631+04:00"
    }
  }
]
```
## Реализация

##### 1. Версионирование баннеров

Считая, что основное назначение сервиса - получение пользователями баннеров, а работа администратора в нем представляет 
малую часть, база данных была спроектирована с целью производительности при выдаче данных. Версии баннеров - полностью 
функционал администратора, и нет смысла увеличивать таблицу в 4 раза. Поэтому создаем таблицу истории (SCD Type 4) с 
триггером на изменение оригинальной таблицы. Для возврата старого значения можно отправить patch запрос с интересующей 
версией при получении истории.

##### 2. Кэш

Так как сказано адаптировать систему с допущением увеличения времени исполнения по редко запрашиваемым тегам и фичам, то 
реализовываем LFU cache. Делаем кэш учитывая что сервер имеет 1 реплику, иначе бы делали через redis

## ТЗ
## Описание задачи
Необходимо реализовать сервис, который позволяет показывать пользователям баннеры, в зависимости от требуемой фичи и тега пользователя, а также управлять баннерами и связанными с ними тегами и фичами.
## Общие вводные
**Баннер** — это документ, описывающий какой-либо элемент пользовательского интерфейса. Технически баннер представляет собой  JSON-документ неопределенной структуры. 
**Тег** — это сущность для обозначения группы пользователей; представляет собой число (ID тега). 
**Фича** — это домен или функциональность; представляет собой число (ID фичи).  
1. Один баннер может быть связан только с одной фичей и несколькими тегами
2. При этом один тег, как и одна фича, могут принадлежать разным баннерам одновременно
3. Фича и тег однозначно определяют баннер

Так как баннеры являются для пользователя вспомогательным функционалом, допускается, если пользователь в течение короткого срока будет получать устаревшую информацию.  При этом существует часть пользователей (порядка 10%), которым обязательно получать самую актуальную информацию. Для таких пользователей нужно предусмотреть механизм получения информации напрямую из БД.
## Условия
1. Используйте этот [API](https://github.com/avito-tech/backend-trainee-assignment-2024/blob/main/api.yaml)
2. Тегов и фичей небольшое количество (до 1000), RPS — 1k, SLI времени ответа — 50 мс, SLI успешности ответа — 99.99%
3. Для авторизации доступов должны использоваться 2 вида токенов: пользовательский и админский.  Получение баннера может происходить с помощью пользовательского или админского токена, а все остальные действия могут выполняться только с помощью админского токена.  
4. Реализуйте интеграционный или E2E-тест на сценарий получения баннера.
5. Если при получении баннера передан флаг use_last_revision, необходимо отдавать самую актуальную информацию.  В ином случае допускается передача информации, которая была актуальна 5 минут назад.
6. Баннеры могут быть временно выключены. Если баннер выключен, то обычные пользователи не должны его получать, при этом админы должны иметь к нему доступ.

## Дополнительные задания:
1. Адаптировать систему для значительного увеличения количества тегов и фичей, при котором допускается увеличение времени исполнения по редко запрашиваемым тегам и фичам
2. Провести нагрузочное тестирование полученного решения и приложить результаты тестирования к решению
3. Иногда получается так, что необходимо вернуться к одной из трех предыдущих версий баннера в связи с найденной ошибкой в логике, тексте и т.д.  Измените API таким образом, чтобы можно было просмотреть существующие версии баннера и выбрать подходящую версию
4. Реализовать интеграционное или E2E-тестирование для остальных сценариев
5. Описать конфигурацию линтера

<br>В следующей жизни сделать шардирование и репликацию бд, использовать go-mock
